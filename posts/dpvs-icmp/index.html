<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>dpvs icmp session</title>
<link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://scottlx.github.io/favicon.png rel=icon><meta name=description content><meta name=keywords content><meta name=author content="windseek"><meta name=generator content="Hugo 0.144.0"></head><body><header role=banner><hgroup><h1><a href=https://scottlx.github.io/>windseek的博客</a></h1><h2>golang、云计算、SDN、NFV、软件架构</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://scottlx.github.io/tools/>» 工具</option><option value=https://scottlx.github.io/archives/>» 归档</option></select></fieldset><ul class=main-navigation><li><a href=https://scottlx.github.io/tools/ title=工具 target=_blank rel="noopener noreferrer">工具</a></li><li><a href=https://scottlx.github.io/archives/ title=归档 target=_blank rel="noopener noreferrer">归档</a></li></ul><ul class=subscription></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://scottlx.github.io/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Feb 18, 2025
- 1 minute read
- <a href=https://scottlx.github.io/posts/dpvs-icmp/#disqus_thread>Comments</a>
- <a class=label href=https://scottlx.github.io/categories/%e6%8a%80%e6%9c%af%e4%bb%8b%e7%bb%8d/>技术介绍</a></p><h1 class=entry-title>dpvs icmp session</h1></header><div class=entry-content><h1 id=dpvs-icmp-session>dpvs icmp session</h1><p>原生的ipvs仅处理三种类型的ICMP报文：ICMP_DEST_UNREACH、ICMP_SOURCE_QUENCH和ICMP_TIME_EXCEEDED</p><p>对于不是这三种类型的ICMP，则设置为不相关联(related)的ICMP，返回NF_ACCEPT，之后走本机路由流程</p><p>dpvs对ipvs进行了一些修改，修改后逻辑如下</p><h2 id=icmp差错报文流程>icmp差错报文流程</h2><ul><li><p>__dp_vs_in</p></li><li><p>__dp_vs_in_icmp4 （处理icmp差错报文，入参related表示找到了关联的conn）</p><p>若不是ICMP_DEST_UNREACH，ICMP_SOURCE_QUENCH，ICMP_TIME_EXCEEDED，返回到_dp_vs_in走普通conn命中流程</p><p>icmp差错报文，需要将报文头偏移到icmp头内部的ip头，<strong>根据内部ip头查找内部ip的conn</strong>。</p><p>若找到conn，<strong>表明此ICMP报文是由之前客户端的请求报文所触发的，由真实服务器回复的ICMP报文</strong>。将related置1</p><p>若未找到则返回accept，返回到_dp_vs_in走普通conn命中流程</p><ul><li>​ __xmit_inbound_icmp4</li></ul><p>​ 找net和local路由，之后走__dp_vs_xmit_icmp4</p><ul><li>__dp_vs_xmit_icmp4</li></ul><p>​ 数据区的前8个字节恰好覆盖了TCP报文或UDP报文中的端口号字段（前四个字节）</p><p>inbound方向根据内部ip的conn修改数据区目的端口为conn->dport，源端口改为conn->localport，</p><p>outbound方向将目的端口改为conn->cport，源端口改为conn->vport</p><p>​</p><p>client (cport ) &lt;&ndash;> (vport)lb(lport) &lt;&ndash;> rs(dport)</p><p>​ 重新计算icmp头的checksum，走ipv4_output</p></li></ul><p><img src=https://i-blog.csdnimg.cn/blog_migrate/4687e28af632425a7d0f6d66487d954b.png#pic_center alt=报文格式></p><p><strong>实际应用上的问题</strong></p><p>某个rs突然下线，导致有时访问vip轮询到了不可达的rs，rs侧的网关发送了一个dest_unreach的icmp包</p><p>该rs的conn还未老化，__dp_vs_in_icmp4流程根据这个icmp的内部差错ip头找到了还未老化的conn，将icmp数据区的port进行修改发回给client</p><p>但是一般情况，rs下线后，该rs的conn会老化消失，内层conn未命中，还是走外层icmp的conn命中流程转给client。这样内部数据区的端口信息是错的（dport->lport，正确情况是vport->cport）</p><h2 id=非差错报文流程>非差错报文流程</h2><p>返回_dp_vs_in走普通conn命中流程</p><p>原本dp_vs_conn_new流程中，先查找svc。icmp的svc默认使用端口0进行查找。但是ipvsadm命令却对端口0的service添加做了限制，导致无法添加这类svc。</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span> svc <span style=color:#719e07>=</span> <span style=color:#268bd2>dp_vs_service_lookup</span>(iph<span style=color:#719e07>-&gt;</span>af, iph<span style=color:#719e07>-&gt;</span>proto, <span style=color:#719e07>&amp;</span>iph<span style=color:#719e07>-&gt;</span>daddr, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>0</span>,                               mbuf, <span style=color:#b58900>NULL</span>, <span style=color:#719e07>&amp;</span>outwall, <span style=color:#268bd2>rte_lcore_id</span>());
</span></span></code></pre></div><p>若未查到走INET_ACCEPT(也就是继续往下进行走到ipv4_output_fin2查到local路由，若使用dpip addr配上了vip或lip地址，则会触发本地代答)。</p><p>若查到svc，则进行conn的schedule，之后会走dp_vs_laddr_bind，但是dp_vs_laddr_bind不支持icmp协议(可以整改)，最终导致svc可以查到但是conn无法建立，最后走INET_DROP。</p><p>概括一下：</p><ul><li><ul><li>未命中svc，走后续local route，最终本地代答</li><li>命中svc后若conn无法建立，drop</li><li>命中svc且建立conn，发往rs或client</li></ul></li></ul><h3 id=icmp的conn>icmp的conn</h3><p>​</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>_ports[<span style=color:#2aa198>0</span>] <span style=color:#719e07>=</span> <span style=color:#268bd2>icmp4_id</span>(ich);
</span></span><span style=display:flex><span>_ports[<span style=color:#2aa198>1</span>] <span style=color:#719e07>=</span> ich<span style=color:#719e07>-&gt;</span>type <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>8</span> <span style=color:#719e07>|</span> ich<span style=color:#719e07>-&gt;</span>code;
</span></span></code></pre></div><p>Inbound hash和outboundhash的五元组都使用上述这两个port进行哈希，并与conn进行关联。</p><p>具体的laddr和lport保存在conn里面。其中只用到laddr做l3的fullnat。由于icmp协议没有定义proto->fnat_in_handler，因此fnat时，从sa_pool分配到的lport对于icmp来说没有用。</p><p>试想ping request和ping reply场景：</p><p>由于request和reply的ich->type不一样，outboundhash必定不命中(且fnat流程中的laddr_bind还会修改一次outboundhashtuple的dport，修改成sapool分配的port，因此也不会命中outbound hash)。</p><p><strong>一次来回的ping会创建两个conn，且都只命中inboundhash。</strong></p><h2 id=个人认为比较合理的方案>个人认为比较合理的方案</h2><h4 id=ipvsadm>ipvsadm</h4><p>放通port=0的svc的创建，用户需要fwd icmp to rs时，需要添加icmp类型的svc。否则icmp会被vip或者lip代答，不会透传到rs或client</p><h4 id=icmp差错报文>icmp差错报文</h4><p>保持原状，对找不到关联的conn连接的差错报文进行drop。</p><p>但一般情况下若发生差错，关联的conn大概率已经老化，此时做related的处理意义不大</p><h4 id=icmp查询报文>icmp查询报文</h4><p>保持原状，建立icmp conn，来回创建两个conn。</p></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>windseek</span></span>
<time>Feb 18, 2025</time>
<span class=categories>Tags:
<a class=category href=https://scottlx.github.io/tags/dpdk>dpdk</a> <a class=category href=https://scottlx.github.io/tags/dpvs>dpvs</a> <a class=category href=https://scottlx.github.io/tags/%e9%ab%98%e6%80%a7%e8%83%bd%e7%bd%91%e7%bb%9c>高性能网络</a></span></p><p class=meta><a class="basic-alignment left" href=https://scottlx.github.io/posts/dpvs-route%E8%BD%AC%E5%8F%91/ title="dpvs route转发">dpvs route转发</a></p><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//scottlx.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><h1>Sidebar Header</h1><p><p>Here&rsquo;s a
<a href=https://www.google.com target=_blank rel=noopener>link to google</a></p><p>New paragraph</p><p>Another paragraph which has two spaces in the end to create a new line using markdown<br>New line but not a new paragraph</p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="noopener noreferrer" href=https://github.com/scottlx title=https://github.com/scottlx><i class="fa fa-github fa-3x"></i></a></li></ul><section class=odd><h1>Sidebar Links</h1><li><a href=https://scottlx.github.io/about title="About me">About me</a></li></section><section class=even><h1>Recent Posts</h1><ul id=recent_posts></ul></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2025 windseek - <a href=https://scottlx.github.io/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>