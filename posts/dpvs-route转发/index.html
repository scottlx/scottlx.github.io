<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>dpvs route转发</title><link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://scottlx.github.io/favicon.png rel=icon><meta name=description content><meta name=keywords content><meta name=author content="windseek"><meta name=generator content="Hugo 0.119.0"></head><body><header role=banner><hgroup><h1><a href=https://scottlx.github.io/>windseek</a></h1><h2>be curious, be free</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://scottlx.github.io/>» Blog</option><option value=https://scottlx.github.io/archives/>» Archives</option><option value=https://scottlx.github.io/cheatsheet/>» CheatSheet</option><option value=https://scottlx.github.io/about/>» Aboutme</option></select></fieldset><ul class=main-navigation><li><a href=https://scottlx.github.io/ title=Blog>Blog</a></li><li><a href=https://scottlx.github.io/archives/ title=Archives target=_blank rel="noopener noreferrer">Archives</a></li><li><a href=https://scottlx.github.io/cheatsheet/ title=CheatSheet target=_blank rel="noopener noreferrer">CheatSheet</a></li><li><a href=https://scottlx.github.io/about/ title=Aboutme target=_blank rel="noopener noreferrer">Aboutme</a></li></ul><ul class=subscription></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://scottlx.github.io/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Feb 18, 2025
- 1 minute read
- <a href=https://scottlx.github.io/posts/dpvs-route%E8%BD%AC%E5%8F%91/#disqus_thread>Comments</a>
- <a class=label href=https://scottlx.github.io/categories/%e6%8a%80%e6%9c%af%e4%bb%8b%e7%bb%8d/>技术介绍</a></p><h1 class=entry-title>dpvs route转发</h1></header><div class=entry-content><nav id=TableOfContents><ul><li><a href=#路由表结构体>路由表结构体</a></li><li><a href=#路由类型>路由类型</a></li><li><a href=#路由表类型>路由表类型</a></li><li><a href=#路由的添加>路由的添加</a></li><li><a href=#转发逻辑>转发逻辑</a></li></ul></nav><p>ipv4_rcv_fin 是路由转发逻辑， INET_HOOKPRE_ROUTING 中走完hook逻辑后，根据dpvs返回值走ipv4_rcv_fin</p><h2 id=路由表结构体>路由表结构体</h2><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#719e07>struct</span> route_entry {
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint8_t</span> netmask;
</span></span><span style=display:flex><span>    <span style=color:#dc322f>short</span> metric;
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint32_t</span> flag;
</span></span><span style=display:flex><span>    <span style=color:#dc322f>unsigned</span> <span style=color:#dc322f>long</span> mtu;
</span></span><span style=display:flex><span>    <span style=color:#719e07>struct</span> list_head list;
</span></span><span style=display:flex><span>    <span style=color:#719e07>struct</span> in_addr dest; <span style=color:#586e75>//cf-&gt;dst.in
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>struct</span> in_addr gw;<span style=color:#586e75>// 下一跳地址，0说明是直连路由，下一跳地址就是报文自己的目的地址，对应配置的cf-&gt;via.in
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>struct</span> in_addr src; <span style=color:#586e75>// cf-&gt;src.in， 源地址策略路由匹配
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>struct</span> netif_port <span style=color:#719e07>*</span>port;  <span style=color:#586e75>// 出接口
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#dc322f>rte_atomic32_t</span> refcnt;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h2 id=路由类型>路由类型</h2><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#586e75>/* dpvs defined. */</span>
</span></span><span style=display:flex><span><span style=color:#719e07>#define RTF_FORWARD     0x0400
</span></span></span><span style=display:flex><span><span style=color:#719e07>#define RTF_LOCALIN     0x0800
</span></span></span><span style=display:flex><span><span style=color:#719e07>#define RTF_DEFAULT     0x1000
</span></span></span><span style=display:flex><span><span style=color:#719e07>#define RTF_KNI         0X2000
</span></span></span><span style=display:flex><span><span style=color:#719e07>#define RTF_OUTWALL     0x4000
</span></span></span></code></pre></div><h2 id=路由表类型>路由表类型</h2><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#719e07>#define this_route_lcore        (RTE_PER_LCORE(route_lcore))
</span></span></span><span style=display:flex><span><span style=color:#719e07>#define this_local_route_table  (this_route_lcore.local_route_table)
</span></span></span><span style=display:flex><span><span style=color:#719e07>#define this_net_route_table    (this_route_lcore.net_route_table)
</span></span></span><span style=display:flex><span><span style=color:#719e07>#define this_gfw_route_table    (this_route_lcore.gfw_route_table)
</span></span></span><span style=display:flex><span><span style=color:#719e07>#define this_num_routes         (RTE_PER_LCORE(num_routes))
</span></span></span><span style=display:flex><span><span style=color:#719e07>#define this_num_out_routes      (RTE_PER_LCORE(num_out_routes))
</span></span></span></code></pre></div><ul><li>Local 类型路由</li></ul><p>local 类型路由的作用和 Linux 下的 local 路由表的功能基本一样，主要是记录本地的 IP 地址。
我们知道进入的数据包，过了 prerouting 后是需要经过路由查找，如果确定是本地路由（本地 IP）就会进入 LocalIn 位置，否则丢弃或进入 Forward。</p><p>Local 类型路由就是用来判定接收数据包是否是本机 IP，在 DPVS 调用的就是 route4_input 函数</p><ul><li>Net 类型路由</li></ul><p>数据包经过应用程序处理完毕后，要执行 output 时也需要根据目的 IP 来查找路由，确定从哪个网卡出去，下一跳等信息，然后执行后续操作。</p><p>在 DPVS 调用的就是 route4_output 函数。</p><p>使用dpip工具添加ip地址时，同时也会添加一条local路由和net路由</p><ul><li>gfw table</li></ul><p>是新特性，可以理解成是另外一张路由表，用来做策略路由用的。如果conn的flag有outwall，则走这个表转发。一般不用这个表。</p><p><a href=https://github.com/iqiyi/dpvs/issues/564 target=_blank rel=noopener>What is ipset and outwall route in DPVS? · Issue #564 · iqiyi/dpvs (github.com)</a></p><h2 id=路由的添加>路由的添加</h2><p><em>dpip route add</em></p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#719e07>static</span> <span style=color:#dc322f>int</span> <span style=color:#268bd2>route4_do_cmd</span>(<span style=color:#719e07>struct</span> dpip_obj <span style=color:#719e07>*</span>obj, <span style=color:#dc322f>dpip_cmd_t</span> cmd,
</span></span><span style=display:flex><span>                        <span style=color:#719e07>struct</span> dpip_conf <span style=color:#719e07>*</span>conf)
</span></span></code></pre></div><p>命令行添加时，是根据scope来确定路由的类型的</p><p>ROUTE_CF_SCOPE_HOST &ndash; >RTF_LOCALIN</p><p>ROUTE_CF_SCOPE_KNI &ndash;> RTF_KNI</p><p>Cf->utwalltb &ndash;> RTF_OUTWALL</p><p>其他 &ndash; > RTF_FORWARD</p><h2 id=转发逻辑>转发逻辑</h2><p><strong>ipv4_rcv_fin</strong> 是路由转发逻辑</p><p>如果找到的route 有forward的flag：
<strong>rt->flag & RTF_FORWARD</strong>
则走转发逻辑 <em>ipv4_forward &ndash;> ipv4_output_fin2</em>
这个时候，路由表项rt已经带在mbuf的userdata里面了，后面的处理函数都能拿到这个包的路由</p><p>Rt->gw 表示网关地址，如果没有网关，这个值是0，说明是直连路由，直接往报文的目的ip （ip4_hdr(mbuf)->dst_addr）发送 ；</p><p>否则，往这个网关发送</p></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>windseek</span></span>
<time>Feb 18, 2025</time>
<span class=categories>Tags:
<a class=category href=https://scottlx.github.io/tags/dpdk>dpdk</a> <a class=category href=https://scottlx.github.io/tags/dpvs>dpvs</a> <a class=category href=https://scottlx.github.io/tags/%e9%ab%98%e6%80%a7%e8%83%bd%e7%bd%91%e7%bb%9c>高性能网络</a></span></p><p class=meta><a class="basic-alignment left" href=https://scottlx.github.io/posts/dpvs-session%E5%90%8C%E6%AD%A5/ title="dpvs session 同步">dpvs session 同步</a>
<a class="basic-alignment right" href=https://scottlx.github.io/posts/dpvs-icmp/ title="dpvs icmp session">dpvs icmp session</a></p><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//scottlx.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><h1>Who am I</h1><p><p>云原生网络开发 &ndash;> 高级网管(笑</p><p>golang、云计算、SDN、NFV、软件架构</p><p>记录一些工作上的笔记，主要是以太网数据面开发（包括不限于dpdk，ebpf，ovs，dpvs，vpp&mldr;)以及k8s</p><p>也会记录一些web3方面的学习探索</p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="noopener noreferrer" href=https://github.com/scottlx title=https://github.com/scottlx><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href="https://www.facebook.com/profile.php?id=100009824623685" title="https://www.facebook.com/profile.php?id=100009824623685"><i class="fa fa-facebook fa-3x"></i></a></li></ul><section class=odd></section><section class=even><h1>Recent Posts</h1><ul id=recent_posts></ul></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2025 windseek - <a href=https://scottlx.github.io/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>