<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>etcd client v3 连接流程 | windseek的博客</title>
<meta property="og:title" content="etcd client v3 连接流程 - windseek的博客"><meta property="og:type" content="article"><meta property="article:published_time" content="2022-10-28T09:15:00+08:00"><meta property="article:modified_time" content="2022-10-28T09:15:00+08:00"><meta name=Keywords content="golang,云计算,SDN,NFV,openvswitch,vpp,k8s,openstack"><meta name=description content="etcd client v3 连接流程"><meta name=author content="windseek"><meta property="og:url" content="https://scottlx.github.io/posts/etcd-client-v3%E8%BF%9E%E6%8E%A5%E6%B5%81%E7%A8%8B/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script><link rel=stylesheet href=/css/douban.css><link rel=stylesheet href=/css/other.css></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href=https://scottlx.github.io>windseek的博客</a><p class=description>专注于golang、云计算、SDN、NFV、软件架构</p></div><div><nav id=nav-menu class=clearfix><a class=current href=https://scottlx.github.io>首页</a>
<a href=https://scottlx.github.io/tools/ title=工具>工具</a>
<a href=https://scottlx.github.io/archives/ title=归档>归档</a>
<a href=https://scottlx.github.io/about/ title=关于>关于</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>etcd client v3 连接流程</h1></header><date class="post-meta meta-date">2022年10月28日</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=/categories/%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90 target=_blank>问题分析</a></span></div><div class=post-meta><span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
阅读</span></span></div><div class=post-content><h1 id=etcd-client-v3-连接流程>etcd client v3 连接流程</h1><p>首先需要了解grpc框架的一些概念，这边引用网上的一张图</p><p><img class=mx-auto alt=img src=https://upload-images.jianshu.io/upload_images/18509379-b2199d257be6b93e.png?imageMogr2/auto-orient/strip%7cimageView2/2/w/953/format/webp></p><h3 id=resolver>Resolver</h3><p>提供一个用户自定义的解析、修改地址的方法，使得用户可以自己去实现地址解析的逻辑、做服务发现、地址更新等等功能。</p><ol><li>将Endpoints里的ETCD服务器地址(127.0.0.1:2379这种格式)做一次转换传给grpc框架。也可以自己重新写此resolver，做服务发现功能。例如etcd服务器地址写nacos之类的地址，在resolver中写好转换逻辑。</li><li>调用ClientConn的ParseServiceConfig接口告诉endpoints的负载策略是轮询</li></ol><h3 id=balancer>Balancer</h3><ol><li>管理subConns，并收集各conn信息，更新状态至ClientConn</li><li>生成picker(balancer)的快照，从而ClientConn可以选择发送rpc请求的subConn</li></ol><p>此处etcd client没有实现balancer，默认使用grpc提供的轮询的balancer</p><h3 id=重试策略>重试策略</h3><p>与一般的c-s模型不同，etcd client的重试是针对集群的重试。单个节点的断连不会造成所有节点的重连。</p><h4 id=重试机制>重试机制</h4><p>一般的重试是对同一个节点进行重试，但etcd client的自动重试不会在ETCD集群的同一节点上进行，是轮询重试集群的每个节点。重试时不会重新建连，而是使用balancer提供的transport。transport的状态更新与这一块的重试是通过balancer解耦的。</p><h4 id=重试条件>重试条件</h4><h5 id=etcd-unary拦截器>etcd unary拦截器</h5><p>拦截器类似http里的中间件的概念，在发送实际请求之前对报文进行篡改。一般用来添加认证，日志记录，缓存之类的功能。</p><p>此处etcd的一元拦截器主要做了自动重试的功能，且只会重试一些特定的错误(DeadlineExceeded, Canceled,ErrInvalidAuthToken)</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> (c <span style=color:#000;font-weight:700>*</span>Client) <span style=color:#900;font-weight:700>unaryClientInterceptor</span>(optFuncs <span style=color:#000;font-weight:700>...</span>retryOption) grpc.UnaryClientInterceptor {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>if</span> <span style=color:#900;font-weight:700>isContextError</span>(lastErr) {
</span></span><span style=display:flex><span>				<span style=color:#000;font-weight:700>if</span> ctx.<span style=color:#900;font-weight:700>Err</span>() <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#998;font-style:italic>// its the context deadline or cancellation.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>					<span style=color:#000;font-weight:700>return</span> lastErr
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#998;font-style:italic>// its the callCtx deadline or cancellation, in which case try again.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>				<span style=color:#000;font-weight:700>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>if</span> callOpts.retryAuth <span style=color:#000;font-weight:700>&amp;&amp;</span> rpctypes.<span style=color:#900;font-weight:700>Error</span>(lastErr) <span style=color:#000;font-weight:700>==</span> rpctypes.ErrInvalidAuthToken {
</span></span><span style=display:flex><span>				<span style=color:#998;font-style:italic>// clear auth token before refreshing it.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>				<span style=color:#998;font-style:italic>// call c.Auth.Authenticate with an invalid token will always fail the auth check on the server-side,
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>				<span style=color:#998;font-style:italic>// if the server has not apply the patch of pr #12165 (https://github.com/etcd-io/etcd/pull/12165)
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>				<span style=color:#998;font-style:italic>// and a rpctypes.ErrInvalidAuthToken will recursively call c.getToken until system run out of resource.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>				c.authTokenBundle.<span style=color:#900;font-weight:700>UpdateAuthToken</span>(<span style=color:#d14>&#34;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				gterr <span style=color:#000;font-weight:700>:=</span> c.<span style=color:#900;font-weight:700>getToken</span>(ctx)
</span></span><span style=display:flex><span>				<span style=color:#000;font-weight:700>if</span> gterr <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>					c.<span style=color:#900;font-weight:700>GetLogger</span>().<span style=color:#900;font-weight:700>Warn</span>(
</span></span><span style=display:flex><span>						<span style=color:#d14>&#34;retrying of unary invoker failed to fetch new auth token&#34;</span>,
</span></span><span style=display:flex><span>						zap.<span style=color:#900;font-weight:700>String</span>(<span style=color:#d14>&#34;target&#34;</span>, cc.<span style=color:#900;font-weight:700>Target</span>()),
</span></span><span style=display:flex><span>						zap.<span style=color:#900;font-weight:700>Error</span>(gterr),
</span></span><span style=display:flex><span>					)
</span></span><span style=display:flex><span>					<span style=color:#000;font-weight:700>return</span> gterr <span style=color:#998;font-style:italic>// lastErr must be invalid auth token
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>				}
</span></span><span style=display:flex><span>				<span style=color:#000;font-weight:700>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h4 id=重试次数>重试次数</h4><p>此处Invoke的大循环里，默认callOpts.max是0，也就是说尝试一次Invoke后就会return错误</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>var</span> (
</span></span><span style=display:flex><span>   defaultOptions = <span style=color:#000;font-weight:700>&amp;</span>options{
</span></span><span style=display:flex><span>      retryPolicy: nonRepeatable,
</span></span><span style=display:flex><span>      max:         <span style=color:#099>0</span>, <span style=color:#998;font-style:italic>// disable
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>      backoffFunc: <span style=color:#900;font-weight:700>backoffLinearWithJitter</span>(<span style=color:#099>50</span><span style=color:#000;font-weight:700>*</span>time.Millisecond <span style=color:#998;font-style:italic>/*jitter*/</span>, <span style=color:#099>0.10</span>),
</span></span><span style=display:flex><span>      retryAuth:   <span style=color:#000;font-weight:700>true</span>,
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><h4 id=重试时间>重试时间</h4><p>若重试次数已经达到quorum，则真正的计算间隔时长，间隔时长(25ms左右)到期后，才进行重试。</p><p>否则，直接返回0，也就是马上重试。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> (c <span style=color:#000;font-weight:700>*</span>Client) <span style=color:#900;font-weight:700>roundRobinQuorumBackoff</span>(waitBetween time.Duration,
</span></span><span style=display:flex><span>    jitterFraction <span style=color:#458;font-weight:700>float64</span>) backoffFunc {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>func</span>(attempt <span style=color:#458;font-weight:700>uint</span>) time.Duration {
</span></span><span style=display:flex><span>		n <span style=color:#000;font-weight:700>:=</span> <span style=color:#0086b3>uint</span>(<span style=color:#0086b3>len</span>(c.<span style=color:#900;font-weight:700>Endpoints</span>()))
</span></span><span style=display:flex><span>		quorum <span style=color:#000;font-weight:700>:=</span> (n<span style=color:#000;font-weight:700>/</span><span style=color:#099>2</span> <span style=color:#000;font-weight:700>+</span> <span style=color:#099>1</span>)
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>if</span> attempt<span style=color:#000;font-weight:700>%</span>quorum <span style=color:#000;font-weight:700>==</span> <span style=color:#099>0</span> {
</span></span><span style=display:flex><span>			c.lg.<span style=color:#900;font-weight:700>Debug</span>(<span style=color:#d14>&#34;backoff&#34;</span>, zap.<span style=color:#900;font-weight:700>Uint</span>(<span style=color:#d14>&#34;attempt&#34;</span>, attempt), zap.<span style=color:#900;font-weight:700>Uint</span>(<span style=color:#d14>&#34;quorum&#34;</span>, quorum), zap.<span style=color:#900;font-weight:700>Duration</span>(<span style=color:#d14>&#34;waitBetween&#34;</span>, waitBetween), zap.<span style=color:#900;font-weight:700>Float64</span>(<span style=color:#d14>&#34;jitterFraction&#34;</span>, jitterFraction))
</span></span><span style=display:flex><span>			<span style=color:#000;font-weight:700>return</span> <span style=color:#900;font-weight:700>jitterUp</span>(waitBetween, jitterFraction)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		c.lg.<span style=color:#900;font-weight:700>Debug</span>(<span style=color:#d14>&#34;backoff skipped&#34;</span>, zap.<span style=color:#900;font-weight:700>Uint</span>(<span style=color:#d14>&#34;attempt&#34;</span>, attempt), zap.<span style=color:#900;font-weight:700>Uint</span>(<span style=color:#d14>&#34;quorum&#34;</span>, quorum))
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>return</span> <span style=color:#099>0</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=问题分析>问题分析</h3><p>根据以上基础，分析etcd client启动后修改hosts文件产生错误的原因</p><h4 id=测试环境>测试环境</h4><p>etcd集群1：10.50.44.196（未对client开放端口），10.50.44.174（未对client开放端口）， 10.50.44.170</p><p>etcd集群2：10.50.44.65，10.50.44.69，10.50.44.53</p><p>其中etcd集群1的10.50.44.196与10.50.44.174未对etcd client所在的机器开放端口</p><h4 id=初始阶段>初始阶段</h4><p>最开始时，/etc/hosts文件配置的地址如下</p><pre tabindex=0><code>10.50.44.196 etcdserver1.com
10.50.44.174 etcdserver2.com
10.50.44.170 etcdserver3.com
</code></pre><p>此时从日志中可以看到未开放端口的两个节点对应的subchannel一直处于TRANSIENT_FAILURE和CONNECTING状态。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:05.93148&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>warning <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] grpc: addrConn.createTransport failed to connect to {etcdserver3.com:42379 etcdserver3.com &lt;nil&gt; 0 &lt;nil&gt;}. Err:
</span></span></span><span style=display:flex><span><span style=color:#d14>connection error: desc = \&#34;transport: Error while dialing dial tcp 10.50.44.174:42379: connect: connection refused\&#34;. Reconnecting...&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:05.93152&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>info <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] Subchannel Connectivity change to TRANSIENT_FAILURE&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:10.33892&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>info <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] Subchannel Connectivity change to CONNECTING&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:10.33898&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>info <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] Subchannel picks a new address \&#34;etcdserver2.com:42379\&#34; to connect&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:10.33946&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>warning <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] grpc: addrConn.createTransport failed to connect to {etcdserver2.com:42379 etcdserver2.com &lt;nil&gt; 0 &lt;nil&gt;}. Err:
</span></span></span><span style=display:flex><span><span style=color:#d14>connection error: desc = \&#34;transport: Error while dialing dial tcp 10.50.44.196:42379: connect: connection refused\&#34;. Reconnecting...&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:10.33949&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>info <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] Subchannel Connectivity change to TRANSIENT_FAILURE&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:24.52740&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>info <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] Subchannel Connectivity change to CONNECTING&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:24.52750&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>info <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] Subchannel picks a new address \&#34;etcdserver3.com:42379\&#34; to connect&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:24.52810&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>warning <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] grpc: addrConn.createTransport failed to connect to {etcdserver3.com:42379 etcdserver3.com &lt;nil&gt; 0 &lt;nil&gt;}. Err:
</span></span></span><span style=display:flex><span><span style=color:#d14>connection error: desc = \&#34;transport: Error while dialing dial tcp 10.50.44.174:42379: connect: connection refused\&#34;. Reconnecting...&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:24.52814&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>info <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] Subchannel Connectivity change to TRANSIENT_FAILURE&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:25.98825&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>info <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] Subchannel Connectivity change to CONNECTING&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:25.98833&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>info <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] Subchannel picks a new address \&#34;etcdserver2.com:42379\&#34; to connect&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:25.98891&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>warning <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] grpc: addrConn.createTransport failed to connect to {etcdserver2.com:42379 etcdserver2.com &lt;nil&gt; 0 &lt;nil&gt;}. Err:
</span></span></span><span style=display:flex><span><span style=color:#d14>connection error: desc = \&#34;transport: Error while dialing dial tcp 10.50.44.196:42379: connect: connection refused\&#34;. Reconnecting...&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:25.98897&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>info <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] Subchannel Connectivity change to TRANSIENT_FAILURE&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:47.80826&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>info <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] Subchannel Connectivity change to CONNECTING&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:47.80834&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>info <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] Subchannel picks a new address \&#34;etcdserver2.com:42379\&#34; to connect&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:47.81473&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>info <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] Subchannel Connectivity change to READY&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:47.81483&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>info <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[roundrobin] roundrobinPicker: newPicker called with info: {map[0xc000504330:{{etcdserver1.com:42379 etcdserver1.com &lt;nil&gt;
</span></span></span><span style=display:flex><span><span style=color:#d14> 0 &lt;nil&gt;}} 0xc0005043d0:{{etcdserver2.com:42379 etcdserver2.com &lt;nil&gt; 0 &lt;nil&gt;}}]}&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:51.54254&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>info <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] Subchannel Connectivity change to CONNECTING&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:51.54259&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>info <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] Subchannel picks a new address \&#34;etcdserver3.com:42379\&#34; to connect&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:51.54962&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>info <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;[core] Subchannel Connectivity change to READY&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>grpc-server
</span></span></code></pre></td></tr></table></div></div><p>subchannel的状态在框架内由addrConn控制，创建ClientConn后会从balancer中返回一系列endpoint的地址（状态是不可用的）。之后对于每个地址建立连接(addrConn.resetTransport)，并更新状态。balancer将状态为READY的连接（只有etcdserver3.com）封装成picker提供给client.Conn来连接。</p><p>addrConn.resetTransport里面是一个大循环，对endpoint列表里所有地址重试建立http2连接直到成功(newHTTP2Client)。</p><ol><li>net.dial建立tcp连接，失败的话返回TransientFailure</li><li>http2的流操作：单独启动goroutine，循环读取所有的frame，并发送到相应的stream中去</li></ol><p>默认情况下连接失败会将addrConn的状态修改为TransientFailure，暂时不让ClientConn使用，并等待sleeptime后重试。整个连接尝试持续minConnectTimeout(20s)。连接成功后将addrConn状态置为ready，下次就可以从balancer中读取到这个地址。</p><p>sleeptime计算规则如下，默认BaseDelay = 1s，Multiplier=1.6，且有0.2的Jitter</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#998;font-style:italic>// Backoff returns the amount of time to wait before the next retry given the
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// number of retries.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>func</span> (bc Exponential) <span style=color:#900;font-weight:700>Backoff</span>(retries <span style=color:#458;font-weight:700>int</span>) time.Duration {
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>if</span> retries <span style=color:#000;font-weight:700>==</span> <span style=color:#099>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>return</span> bc.Config.BaseDelay
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	backoff, max <span style=color:#000;font-weight:700>:=</span> <span style=color:#0086b3>float64</span>(bc.Config.BaseDelay), <span style=color:#0086b3>float64</span>(bc.Config.MaxDelay)
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>for</span> backoff &lt; max <span style=color:#000;font-weight:700>&amp;&amp;</span> retries &gt; <span style=color:#099>0</span> {
</span></span><span style=display:flex><span>		backoff <span style=color:#000;font-weight:700>*=</span> bc.Config.Multiplier
</span></span><span style=display:flex><span>		retries<span style=color:#000;font-weight:700>--</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>if</span> backoff &gt; max {
</span></span><span style=display:flex><span>		backoff = max
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#998;font-style:italic>// Randomize backoff delays so that if a cluster of requests start at
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>	<span style=color:#998;font-style:italic>// the same time, they won&#39;t operate in lockstep.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>	backoff <span style=color:#000;font-weight:700>*=</span> <span style=color:#099>1</span> <span style=color:#000;font-weight:700>+</span> bc.Config.Jitter<span style=color:#000;font-weight:700>*</span>(grpcrand.<span style=color:#900;font-weight:700>Float64</span>()<span style=color:#000;font-weight:700>*</span><span style=color:#099>2</span><span style=color:#000;font-weight:700>-</span><span style=color:#099>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>if</span> backoff &lt; <span style=color:#099>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>return</span> <span style=color:#099>0</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>return</span> time.<span style=color:#900;font-weight:700>Duration</span>(backoff)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>测试可以看到每次重连以1，2，4，8的间隔进行重试，且每20s使用一个新端口建连。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>02:59:53.590387 IP 10.20.141.244.44904 &gt; 10.50.66.67.42379: Flags <span style=color:#000;font-weight:700>[</span>S<span style=color:#000;font-weight:700>]</span>, seq 2780622427, win 29200, options <span style=color:#000;font-weight:700>[</span>mss 1460,sackOK,TS val <span style=color:#099>5912872</span> ecr 0,nop,wscale 7<span style=color:#000;font-weight:700>]</span>, length <span style=color:#099>0</span>
</span></span><span style=display:flex><span>02:59:54.592062 IP 10.20.141.244.44904 &gt; 10.50.66.67.42379: Flags <span style=color:#000;font-weight:700>[</span>S<span style=color:#000;font-weight:700>]</span>, seq 2780622427, win 29200, options <span style=color:#000;font-weight:700>[</span>mss 1460,sackOK,TS val <span style=color:#099>5913874</span> ecr 0,nop,wscale 7<span style=color:#000;font-weight:700>]</span>, length <span style=color:#099>0</span>
</span></span><span style=display:flex><span>02:59:56.598068 IP 10.20.141.244.44904 &gt; 10.50.66.67.42379: Flags <span style=color:#000;font-weight:700>[</span>S<span style=color:#000;font-weight:700>]</span>, seq 2780622427, win 29200, options <span style=color:#000;font-weight:700>[</span>mss 1460,sackOK,TS val <span style=color:#099>5915880</span> ecr 0,nop,wscale 7<span style=color:#000;font-weight:700>]</span>, length <span style=color:#099>0</span>
</span></span><span style=display:flex><span>03:00:00.606135 IP 10.20.141.244.44904 &gt; 10.50.66.67.42379: Flags <span style=color:#000;font-weight:700>[</span>S<span style=color:#000;font-weight:700>]</span>, seq 2780622427, win 29200, options <span style=color:#000;font-weight:700>[</span>mss 1460,sackOK,TS val <span style=color:#099>5919888</span> ecr 0,nop,wscale 7<span style=color:#000;font-weight:700>]</span>, length <span style=color:#099>0</span>
</span></span><span style=display:flex><span>03:00:08.622076 IP 10.20.141.244.44904 &gt; 10.50.66.67.42379: Flags <span style=color:#000;font-weight:700>[</span>S<span style=color:#000;font-weight:700>]</span>, seq 2780622427, win 29200, options <span style=color:#000;font-weight:700>[</span>mss 1460,sackOK,TS val <span style=color:#099>5927904</span> ecr 0,nop,wscale 7<span style=color:#000;font-weight:700>]</span>, length <span style=color:#099>0</span>
</span></span><span style=display:flex><span>03:00:14.599452 IP 10.20.141.244.44910 &gt; 10.50.66.67.42379: Flags <span style=color:#000;font-weight:700>[</span>S<span style=color:#000;font-weight:700>]</span>, seq 1525024322, win 29200, options <span style=color:#000;font-weight:700>[</span>mss 1460,sackOK,TS val <span style=color:#099>5933881</span> ecr 0,nop,wscale 7<span style=color:#000;font-weight:700>]</span>, length <span style=color:#099>0</span>
</span></span><span style=display:flex><span>03:00:15.602123 IP 10.20.141.244.44910 &gt; 10.50.66.67.42379: Flags <span style=color:#000;font-weight:700>[</span>S<span style=color:#000;font-weight:700>]</span>, seq 1525024322, win 29200, options <span style=color:#000;font-weight:700>[</span>mss 1460,sackOK,TS val <span style=color:#099>5934884</span> ecr 0,nop,wscale 7<span style=color:#000;font-weight:700>]</span>, length <span style=color:#099>0</span>
</span></span><span style=display:flex><span>03:00:17.606062 IP 10.20.141.244.44910 &gt; 10.50.66.67.42379: Flags <span style=color:#000;font-weight:700>[</span>S<span style=color:#000;font-weight:700>]</span>, seq 1525024322, win 29200, options <span style=color:#000;font-weight:700>[</span>mss 1460,sackOK,TS val <span style=color:#099>5936888</span> ecr 0,nop,wscale 7<span style=color:#000;font-weight:700>]</span>, length <span style=color:#099>0</span>
</span></span><span style=display:flex><span>03:00:21.614064 IP 10.20.141.244.44910 &gt; 10.50.66.67.42379: Flags <span style=color:#000;font-weight:700>[</span>S<span style=color:#000;font-weight:700>]</span>, seq 1525024322, win 29200, options <span style=color:#000;font-weight:700>[</span>mss 1460,sackOK,TS val <span style=color:#099>5940896</span> ecr 0,nop,wscale 7<span style=color:#000;font-weight:700>]</span>, length <span style=color:#099>0</span>
</span></span><span style=display:flex><span>03:00:29.630069 IP 10.20.141.244.44910 &gt; 10.50.66.67.42379: Flags <span style=color:#000;font-weight:700>[</span>S<span style=color:#000;font-weight:700>]</span>, seq 1525024322, win 29200, options <span style=color:#000;font-weight:700>[</span>mss 1460,sackOK,TS val <span style=color:#099>5948912</span> ecr 0,nop,wscale 7<span style=color:#000;font-weight:700>]</span>, length <span style=color:#099>0</span>
</span></span><span style=display:flex><span>03:00:35.912848 IP 10.20.141.244.44914 &gt; 10.50.66.67.42379: Flags <span style=color:#000;font-weight:700>[</span>S<span style=color:#000;font-weight:700>]</span>, seq 2900573510, win 29200, options <span style=color:#000;font-weight:700>[</span>mss 1460,sackOK,TS val <span style=color:#099>5955194</span> ecr 0,nop,wscale 7<span style=color:#000;font-weight:700>]</span>, length <span style=color:#099>0</span>
</span></span><span style=display:flex><span>03:00:36.914126 IP 10.20.141.244.44914 &gt; 10.50.66.67.42379: Flags <span style=color:#000;font-weight:700>[</span>S<span style=color:#000;font-weight:700>]</span>, seq 2900573510, win 29200, options <span style=color:#000;font-weight:700>[</span>mss 1460,sackOK,TS val <span style=color:#099>5956196</span> ecr 0,nop,wscale 7<span style=color:#000;font-weight:700>]</span>, length <span style=color:#099>0</span>
</span></span><span style=display:flex><span>03:00:38.918090 IP 10.20.141.244.44914 &gt; 10.50.66.67.42379: Flags <span style=color:#000;font-weight:700>[</span>S<span style=color:#000;font-weight:700>]</span>, seq 2900573510, win 29200, options <span style=color:#000;font-weight:700>[</span>mss 1460,sackOK,TS val <span style=color:#099>5958200</span> ecr 0,nop,wscale 7<span style=color:#000;font-weight:700>]</span>, length <span style=color:#099>0</span>
</span></span><span style=display:flex><span>03:00:42.926125 IP 10.20.141.244.44914 &gt; 10.50.66.67.42379: Flags <span style=color:#000;font-weight:700>[</span>S<span style=color:#000;font-weight:700>]</span>, seq 2900573510, win 29200, options <span style=color:#000;font-weight:700>[</span>mss 1460,sackOK,TS val <span style=color:#099>5962208</span> ecr 0,nop,wscale 7<span style=color:#000;font-weight:700>]</span>, length <span style=color:#099>0</span>
</span></span><span style=display:flex><span>03:00:50.942069 IP 10.20.141.244.44914 &gt; 10.50.66.67.42379: Flags <span style=color:#000;font-weight:700>[</span>S<span style=color:#000;font-weight:700>]</span>, seq 2900573510, win 29200, options <span style=color:#000;font-weight:700>[</span>mss 1460,sackOK,TS val <span style=color:#099>5970224</span> ecr 0,nop,wscale 7<span style=color:#000;font-weight:700>]</span>, length <span style=color:#099>0</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=变更hosts地址>变更hosts地址</h4><p>第二步，修改hosts文件</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>10.50.44.65 etcdserver1.com
</span></span><span style=display:flex><span>10.50.44.69 etcdserver2.com
</span></span><span style=display:flex><span>10.50.44.53 etcdserver3.com
</span></span></code></pre></td></tr></table></div></div><p>此时连接建立(grpc.dial)成功，调用etcd的put，get等请求时本质上是发起grpc.Invoke请求。</p><p>grpc请求分为stream和unary，这里属于unary请求</p><ol><li>调用拦截器unaryInterceptor</li><li>在拦截器里调用Invoke处理请求过程<ol><li>clientConn.getTransport获取一个连接，出错直接返回<ol><li>轮询从balancer中获取一个可用的地址</li><li>adressConn.Wait等待连接</li></ol></li><li>sendRequest发起请求，生成一个stream对象</li><li>recvResponse接收响应，阻塞等待</li></ol></li></ol><p>可以发现日志的前一部分报code = DeadlineExceeded，context deadline exceeded，后一部分开始报code=InvalidArgument， user name is empty，且之后一直报user name is empty这个错误。报错的endpoint为之前未连接成功的etcderver1.com。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#d14>&#34;level&#34;</span>:<span style=color:#d14>&#34;warn&#34;</span>,<span style=color:#d14>&#34;ts&#34;</span>:<span style=color:#d14>&#34;2022-10-20T14:06:53.839+0800&#34;</span>,<span style=color:#d14>&#34;logger&#34;</span>:<span style=color:#d14>&#34;etcd-client&#34;</span>,<span style=color:#d14>&#34;caller&#34;</span>:<span style=color:#d14>&#34;v3@v3.5.1/retry_interceptor.go:62&#34;</span>,<span style=color:#d14>&#34;msg&#34;</span>:<span style=color:#d14>&#34;retrying of unary invoker failed&#34;</span>,<span style=color:#d14>&#34;target&#34;</span>:<span style=color:#d14>&#34;
</span></span></span><span style=display:flex><span><span style=color:#d14>etcd-endpoints://0xc000511340/etcdserver1.com:42379&#34;</span>,<span style=color:#d14>&#34;attempt&#34;</span>:0,<span style=color:#d14>&#34;error&#34;</span>:<span style=color:#d14>&#34;rpc error: code = Unauthenticated desc = etcdserver: invalid auth token&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#d14>&#34;level&#34;</span>:<span style=color:#d14>&#34;warn&#34;</span>,<span style=color:#d14>&#34;ts&#34;</span>:<span style=color:#d14>&#34;2022-10-20T14:06:53.876+0800&#34;</span>,<span style=color:#d14>&#34;logger&#34;</span>:<span style=color:#d14>&#34;etcd-client&#34;</span>,<span style=color:#d14>&#34;caller&#34;</span>:<span style=color:#d14>&#34;v3@v3.5.1/retry_interceptor.go:62&#34;</span>,<span style=color:#d14>&#34;msg&#34;</span>:<span style=color:#d14>&#34;retrying of unary invoker failed&#34;</span>,<span style=color:#d14>&#34;target&#34;</span>:<span style=color:#d14>&#34;
</span></span></span><span style=display:flex><span><span style=color:#d14>etcd-endpoints://0xc000511340/etcdserver1.com:42379&#34;</span>,<span style=color:#d14>&#34;attempt&#34;</span>:0,<span style=color:#d14>&#34;error&#34;</span>:<span style=color:#d14>&#34;rpc error: code = InvalidArgument desc = etcdserver: user name is empty&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:53.87629&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>error <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;etcd get error: etcdserver: user name is empty&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>etcd
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#d14>&#34;level&#34;</span>:<span style=color:#d14>&#34;warn&#34;</span>,<span style=color:#d14>&#34;ts&#34;</span>:<span style=color:#d14>&#34;2022-10-20T14:06:57.033+0800&#34;</span>,<span style=color:#d14>&#34;logger&#34;</span>:<span style=color:#d14>&#34;etcd-client&#34;</span>,<span style=color:#d14>&#34;caller&#34;</span>:<span style=color:#d14>&#34;v3@v3.5.1/retry_interceptor.go:62&#34;</span>,<span style=color:#d14>&#34;msg&#34;</span>:<span style=color:#d14>&#34;retrying of unary invoker failed&#34;</span>,<span style=color:#d14>&#34;target&#34;</span>:<span style=color:#d14>&#34;
</span></span></span><span style=display:flex><span><span style=color:#d14>etcd-endpoints://0xc000511340/etcdserver1.com:42379&#34;</span>,<span style=color:#d14>&#34;attempt&#34;</span>:0,<span style=color:#d14>&#34;error&#34;</span>:<span style=color:#d14>&#34;rpc error: code = DeadlineExceeded desc = context deadline exceeded&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:06:57.03316&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>error <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;etcd put error: context deadline exceeded&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>etcd
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#d14>&#34;level&#34;</span>:<span style=color:#d14>&#34;warn&#34;</span>,<span style=color:#d14>&#34;ts&#34;</span>:<span style=color:#d14>&#34;2022-10-20T14:07:00.202+0800&#34;</span>,<span style=color:#d14>&#34;logger&#34;</span>:<span style=color:#d14>&#34;etcd-client&#34;</span>,<span style=color:#d14>&#34;caller&#34;</span>:<span style=color:#d14>&#34;v3@v3.5.1/retry_interceptor.go:62&#34;</span>,<span style=color:#d14>&#34;msg&#34;</span>:<span style=color:#d14>&#34;retrying of unary invoker failed&#34;</span>,<span style=color:#d14>&#34;target&#34;</span>:<span style=color:#d14>&#34;
</span></span></span><span style=display:flex><span><span style=color:#d14>etcd-endpoints://0xc000511340/etcdserver1.com:42379&#34;</span>,<span style=color:#d14>&#34;attempt&#34;</span>:0,<span style=color:#d14>&#34;error&#34;</span>:<span style=color:#d14>&#34;rpc error: code = DeadlineExceeded desc = context deadline exceeded&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:07:00.20305&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>error <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;etcd put error: context deadline exceeded&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>etcd
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#d14>&#34;level&#34;</span>:<span style=color:#d14>&#34;warn&#34;</span>,<span style=color:#d14>&#34;ts&#34;</span>:<span style=color:#d14>&#34;2022-10-20T14:07:03.236+0800&#34;</span>,<span style=color:#d14>&#34;logger&#34;</span>:<span style=color:#d14>&#34;etcd-client&#34;</span>,<span style=color:#d14>&#34;caller&#34;</span>:<span style=color:#d14>&#34;v3@v3.5.1/retry_interceptor.go:62&#34;</span>,<span style=color:#d14>&#34;msg&#34;</span>:<span style=color:#d14>&#34;retrying of unary invoker failed&#34;</span>,<span style=color:#d14>&#34;target&#34;</span>:<span style=color:#d14>&#34;
</span></span></span><span style=display:flex><span><span style=color:#d14>etcd-endpoints://0xc000511340/etcdserver1.com:42379&#34;</span>,<span style=color:#d14>&#34;attempt&#34;</span>:0,<span style=color:#d14>&#34;error&#34;</span>:<span style=color:#d14>&#34;rpc error: code = DeadlineExceeded desc = context deadline exceeded&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:07:03.23630&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>error <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;etcd put error: context deadline exceeded&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>etcd
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#d14>&#34;level&#34;</span>:<span style=color:#d14>&#34;warn&#34;</span>,<span style=color:#d14>&#34;ts&#34;</span>:<span style=color:#d14>&#34;2022-10-20T14:07:06.243+0800&#34;</span>,<span style=color:#d14>&#34;logger&#34;</span>:<span style=color:#d14>&#34;etcd-client&#34;</span>,<span style=color:#d14>&#34;caller&#34;</span>:<span style=color:#d14>&#34;v3@v3.5.1/retry_interceptor.go:62&#34;</span>,<span style=color:#d14>&#34;msg&#34;</span>:<span style=color:#d14>&#34;retrying of unary invoker failed&#34;</span>,<span style=color:#d14>&#34;target&#34;</span>:<span style=color:#d14>&#34;
</span></span></span><span style=display:flex><span><span style=color:#d14>etcd-endpoints://0xc000511340/etcdserver1.com:42379&#34;</span>,<span style=color:#d14>&#34;attempt&#34;</span>:0,<span style=color:#d14>&#34;error&#34;</span>:<span style=color:#d14>&#34;rpc error: code = Unauthenticated desc = etcdserver: invalid auth token&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#d14>&#34;level&#34;</span>:<span style=color:#d14>&#34;warn&#34;</span>,<span style=color:#d14>&#34;ts&#34;</span>:<span style=color:#d14>&#34;2022-10-20T14:07:06.243+0800&#34;</span>,<span style=color:#d14>&#34;logger&#34;</span>:<span style=color:#d14>&#34;etcd-client&#34;</span>,<span style=color:#d14>&#34;caller&#34;</span>:<span style=color:#d14>&#34;v3@v3.5.1/retry_interceptor.go:62&#34;</span>,<span style=color:#d14>&#34;msg&#34;</span>:<span style=color:#d14>&#34;retrying of unary invoker failed&#34;</span>,<span style=color:#d14>&#34;target&#34;</span>:<span style=color:#d14>&#34;
</span></span></span><span style=display:flex><span><span style=color:#d14>etcd-endpoints://0xc000511340/etcdserver1.com:42379&#34;</span>,<span style=color:#d14>&#34;attempt&#34;</span>:0,<span style=color:#d14>&#34;error&#34;</span>:<span style=color:#d14>&#34;rpc error: code = DeadlineExceeded desc = context deadline exceeded&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#d14>&#34;level&#34;</span>:<span style=color:#d14>&#34;warn&#34;</span>,<span style=color:#d14>&#34;ts&#34;</span>:<span style=color:#d14>&#34;2022-10-20T14:07:06.243+0800&#34;</span>,<span style=color:#d14>&#34;logger&#34;</span>:<span style=color:#d14>&#34;etcd-client&#34;</span>,<span style=color:#d14>&#34;caller&#34;</span>:<span style=color:#d14>&#34;v3@v3.5.1/retry_interceptor.go:85&#34;</span>,<span style=color:#d14>&#34;msg&#34;</span>:<span style=color:#d14>&#34;retrying of unary invoker failed to fetch ne
</span></span></span><span style=display:flex><span><span style=color:#d14>w auth token&#34;</span>,<span style=color:#d14>&#34;target&#34;</span>:<span style=color:#d14>&#34;etcd-endpoints://0xc000511340/etcdserver1.com:42379&#34;</span>,<span style=color:#d14>&#34;error&#34;</span>:<span style=color:#d14>&#34;context deadline exceeded&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:07:06.24336&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>error <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;etcd put error: context deadline exceeded&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>etcd
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#d14>&#34;level&#34;</span>:<span style=color:#d14>&#34;warn&#34;</span>,<span style=color:#d14>&#34;ts&#34;</span>:<span style=color:#d14>&#34;2022-10-20T14:07:06.273+0800&#34;</span>,<span style=color:#d14>&#34;logger&#34;</span>:<span style=color:#d14>&#34;etcd-client&#34;</span>,<span style=color:#d14>&#34;caller&#34;</span>:<span style=color:#d14>&#34;v3@v3.5.1/retry_interceptor.go:62&#34;</span>,<span style=color:#d14>&#34;msg&#34;</span>:<span style=color:#d14>&#34;retrying of unary invoker failed&#34;</span>,<span style=color:#d14>&#34;target&#34;</span>:<span style=color:#d14>&#34;
</span></span></span><span style=display:flex><span><span style=color:#d14>etcd-endpoints://0xc000511340/etcdserver1.com:42379&#34;</span>,<span style=color:#d14>&#34;attempt&#34;</span>:0,<span style=color:#d14>&#34;error&#34;</span>:<span style=color:#d14>&#34;rpc error: code = InvalidArgument desc = etcdserver: user name is empty&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:07:06.27355&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>error <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;etcd put error: etcdserver: user name is empty&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>etcd
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#d14>&#34;level&#34;</span>:<span style=color:#d14>&#34;warn&#34;</span>,<span style=color:#d14>&#34;ts&#34;</span>:<span style=color:#d14>&#34;2022-10-20T14:07:06.326+0800&#34;</span>,<span style=color:#d14>&#34;logger&#34;</span>:<span style=color:#d14>&#34;etcd-client&#34;</span>,<span style=color:#d14>&#34;caller&#34;</span>:<span style=color:#d14>&#34;v3@v3.5.1/retry_interceptor.go:62&#34;</span>,<span style=color:#d14>&#34;msg&#34;</span>:<span style=color:#d14>&#34;retrying of unary invoker failed&#34;</span>,<span style=color:#d14>&#34;target&#34;</span>:<span style=color:#d14>&#34;
</span></span></span><span style=display:flex><span><span style=color:#d14>etcd-endpoints://0xc000511340/etcdserver1.com:42379&#34;</span>,<span style=color:#d14>&#34;attempt&#34;</span>:0,<span style=color:#d14>&#34;error&#34;</span>:<span style=color:#d14>&#34;rpc error: code = InvalidArgument desc = etcdserver: user name is empty&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:07:06.32669&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>error <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;etcd put error: etcdserver: user name is empty&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>etcd
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#d14>&#34;level&#34;</span>:<span style=color:#d14>&#34;warn&#34;</span>,<span style=color:#d14>&#34;ts&#34;</span>:<span style=color:#d14>&#34;2022-10-20T14:07:06.355+0800&#34;</span>,<span style=color:#d14>&#34;logger&#34;</span>:<span style=color:#d14>&#34;etcd-client&#34;</span>,<span style=color:#d14>&#34;caller&#34;</span>:<span style=color:#d14>&#34;v3@v3.5.1/retry_interceptor.go:62&#34;</span>,<span style=color:#d14>&#34;msg&#34;</span>:<span style=color:#d14>&#34;retrying of unary invoker failed&#34;</span>,<span style=color:#d14>&#34;target&#34;</span>:<span style=color:#d14>&#34;
</span></span></span><span style=display:flex><span><span style=color:#d14>etcd-endpoints://0xc000511340/etcdserver1.com:42379&#34;</span>,<span style=color:#d14>&#34;attempt&#34;</span>:0,<span style=color:#d14>&#34;error&#34;</span>:<span style=color:#d14>&#34;rpc error: code = InvalidArgument desc = etcdserver: user name is empty&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:07:06.35588&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>error <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;etcd put error: etcdserver: user name is empty&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>etcd
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#d14>&#34;level&#34;</span>:<span style=color:#d14>&#34;warn&#34;</span>,<span style=color:#d14>&#34;ts&#34;</span>:<span style=color:#d14>&#34;2022-10-20T14:07:06.432+0800&#34;</span>,<span style=color:#d14>&#34;logger&#34;</span>:<span style=color:#d14>&#34;etcd-client&#34;</span>,<span style=color:#d14>&#34;caller&#34;</span>:<span style=color:#d14>&#34;v3@v3.5.1/retry_interceptor.go:62&#34;</span>,<span style=color:#d14>&#34;msg&#34;</span>:<span style=color:#d14>&#34;retrying of unary invoker failed&#34;</span>,<span style=color:#d14>&#34;target&#34;</span>:<span style=color:#d14>&#34;
</span></span></span><span style=display:flex><span><span style=color:#d14>etcd-endpoints://0xc000511340/etcdserver1.com:42379&#34;</span>,<span style=color:#d14>&#34;attempt&#34;</span>:0,<span style=color:#d14>&#34;error&#34;</span>:<span style=color:#d14>&#34;rpc error: code = InvalidArgument desc = etcdserver: user name is empty&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:teal>time</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;2022-10-20 14:07:06.43230&#34;</span> <span style=color:teal>level</span><span style=color:#000;font-weight:700>=</span>error <span style=color:teal>msg</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;etcd put error: etcdserver: user name is empty&#34;</span> <span style=color:teal>logger</span><span style=color:#000;font-weight:700>=</span>etcd
</span></span></code></pre></td></tr></table></div></div><p>可以看到每次retry时使用的client是同一个0xc000511340，表示没有重新创建clientConn。每次的attempt都是0，表示每次尝试都只尝试一次直接退出了</p><p>前一部分错误是因为client使用老的transport，但修改了hosts文件，导致无法建连，因此超过opTimeout(这里设置的3s)。客户端代码如下</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> (db <span style=color:#000;font-weight:700>*</span>BytesConnectionEtcd) <span style=color:#900;font-weight:700>Put</span>(key <span style=color:#458;font-weight:700>string</span>, binData []<span style=color:#458;font-weight:700>byte</span>, opts <span style=color:#000;font-weight:700>...</span>datasync.PutOption) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>return</span> <span style=color:#900;font-weight:700>putInternal</span>(db.Logger, db.etcdClient, db.lessor, db.opTimeout, db.session, key, binData, opts<span style=color:#000;font-weight:700>...</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>putInternal</span>(log logging.Logger, kv clientv3.KV, lessor clientv3.Lease, opTimeout time.Duration, session <span style=color:#000;font-weight:700>*</span>concurrency.Session, key <span style=color:#458;font-weight:700>string</span>,
</span></span><span style=display:flex><span>	binData []<span style=color:#458;font-weight:700>byte</span>, opts <span style=color:#000;font-weight:700>...</span>datasync.PutOption) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	deadline <span style=color:#000;font-weight:700>:=</span> time.<span style=color:#900;font-weight:700>Now</span>().<span style=color:#900;font-weight:700>Add</span>(opTimeout)
</span></span><span style=display:flex><span>	ctx, cancel <span style=color:#000;font-weight:700>:=</span> context.<span style=color:#900;font-weight:700>WithDeadline</span>(context.<span style=color:#900;font-weight:700>Background</span>(), deadline)
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>defer</span> <span style=color:#900;font-weight:700>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>var</span> etcdOpts []clientv3.OpOption
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>for</span> _, o <span style=color:#000;font-weight:700>:=</span> <span style=color:#000;font-weight:700>range</span> opts {
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>if</span> withTTL, ok <span style=color:#000;font-weight:700>:=</span> o.(<span style=color:#000;font-weight:700>*</span>datasync.WithTTLOpt); ok <span style=color:#000;font-weight:700>&amp;&amp;</span> withTTL.TTL &gt; <span style=color:#099>0</span> {
</span></span><span style=display:flex><span>			lease, err <span style=color:#000;font-weight:700>:=</span> lessor.<span style=color:#900;font-weight:700>Grant</span>(ctx, <span style=color:#0086b3>int64</span>(withTTL.TTL<span style=color:#000;font-weight:700>/</span>time.Second))
</span></span><span style=display:flex><span>			<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#000;font-weight:700>return</span> err
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			etcdOpts = <span style=color:#0086b3>append</span>(etcdOpts, clientv3.<span style=color:#900;font-weight:700>WithLease</span>(lease.ID))
</span></span><span style=display:flex><span>		} <span style=color:#000;font-weight:700>else</span> <span style=color:#000;font-weight:700>if</span> _, ok <span style=color:#000;font-weight:700>:=</span> o.(<span style=color:#000;font-weight:700>*</span>datasync.WithClientLifetimeTTLOpt); ok <span style=color:#000;font-weight:700>&amp;&amp;</span> session <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>			etcdOpts = <span style=color:#0086b3>append</span>(etcdOpts, clientv3.<span style=color:#900;font-weight:700>WithLease</span>(session.<span style=color:#900;font-weight:700>Lease</span>()))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>if</span> _, err <span style=color:#000;font-weight:700>:=</span> kv.<span style=color:#900;font-weight:700>Put</span>(ctx, key, <span style=color:#0086b3>string</span>(binData), etcdOpts<span style=color:#000;font-weight:700>...</span>); err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		log.<span style=color:#900;font-weight:700>Error</span>(<span style=color:#d14>&#34;etcd put error: &#34;</span>, err)
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>return</span> err
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>后一部分的user name is empty，由于使用旧的token连接新的集群，首次会报code = Unauthenticated desc = etcdserver: invalid auth token"。之后走下面分支重新获取token</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>if</span> callOpts.retryAuth <span style=color:#000;font-weight:700>&amp;&amp;</span> rpctypes.<span style=color:#900;font-weight:700>Error</span>(lastErr) <span style=color:#000;font-weight:700>==</span> rpctypes.ErrInvalidAuthToken {
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>// clear auth token before refreshing it.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>   <span style=color:#998;font-style:italic>// call c.Auth.Authenticate with an invalid token will always fail the auth check on the server-side,
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>   <span style=color:#998;font-style:italic>// if the server has not apply the patch of pr #12165 (https://github.com/etcd-io/etcd/pull/12165)
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>   <span style=color:#998;font-style:italic>// and a rpctypes.ErrInvalidAuthToken will recursively call c.getToken until system run out of resource.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>   c.authTokenBundle.<span style=color:#900;font-weight:700>UpdateAuthToken</span>(<span style=color:#d14>&#34;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   gterr <span style=color:#000;font-weight:700>:=</span> c.<span style=color:#900;font-weight:700>getToken</span>(ctx)
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>if</span> gterr <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>      c.<span style=color:#900;font-weight:700>GetLogger</span>().<span style=color:#900;font-weight:700>Warn</span>(
</span></span><span style=display:flex><span>         <span style=color:#d14>&#34;retrying of unary invoker failed to fetch new auth token&#34;</span>,
</span></span><span style=display:flex><span>         zap.<span style=color:#900;font-weight:700>String</span>(<span style=color:#d14>&#34;target&#34;</span>, cc.<span style=color:#900;font-weight:700>Target</span>()),
</span></span><span style=display:flex><span>         zap.<span style=color:#900;font-weight:700>Error</span>(gterr),
</span></span><span style=display:flex><span>      )
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>return</span> gterr <span style=color:#998;font-style:italic>// lastErr must be invalid auth token
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>   }
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>continue</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>重新获取token时，显示user name被清空，但走读代码没有发现清空user name的部分。该问题先mark，需要后续debug一下代码来分析。</p></div><div class=post-archive><ul class=post-copyright><li><strong>原文作者：</strong><a rel=author href=https://scottlx.github.io>windseek</a></li><li style=word-break:break-all><strong>原文链接：</strong><a href=https://scottlx.github.io/posts/etcd-client-v3%E8%BF%9E%E6%8E%A5%E6%B5%81%E7%A8%8B/>https://scottlx.github.io/posts/etcd-client-v3%E8%BF%9E%E6%8E%A5%E6%B5%81%E7%A8%8B/</a></li><li><strong>版权声明：</strong>本作品采用<a rel=license href=https://creativecommons.org/licenses/by-nc-nd/4.0/>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li></ul></div><br><div class=post-archive><h2>See Also</h2><ul class=listing><li><a href=/posts/%E5%8D%95%E8%B0%83%E6%A0%88/>单调栈</a></li><li><a href=/posts/%E6%8B%93%E6%89%91%E6%8E%92%E5%BA%8F/>拓扑排序(选课)</a></li><li><a href=/posts/%E4%BC%98%E5%8A%BF%E6%B4%97%E7%89%8C%E7%94%B0%E5%BF%8C%E8%B5%9B%E9%A9%AC/>优势洗牌(田忌赛马)</a></li><li><a href=/posts/%E6%95%B0%E4%BD%8Ddp/>数位dp</a></li><li><a href=/posts/K8S%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/>k8s源码分析</a></li></ul></div><div class="post-meta meta-tags"><ul class=clearfix><li><a href=/tags/go target=_blank>go</a></li><li><a href=/tags/etcd target=_blank>etcd</a></li><li><a href=/tags/grpc target=_blank>grpc</a></li></ul></div></article><div class="post bg-white"><script src=https://utteranc.es/client.js repo=scottlx/scottlx.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><footer id=footer><div>&copy; 2023 <a href=https://scottlx.github.io>windseek的博客 By windseek</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[["$","$"]],processEscapes:!0}}</script><script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><a id=rocket href=#top></a><script type=text/javascript src='/js/totop.js?v=0.0.0' async></script><style type=text/css>div.highlight{position:relative;margin:1em 0}.copy-code{display:none;position:absolute;top:4px;right:4px;color:rgba(255,255,255,.8);background:rgba(78,78,78,.8);border-radius:var(--radius);padding:0 5px;font:inherit;user-select:none;cursor:pointer;border:0;--radius:8px}div.highlight:hover .copy-code,pre:hover .copy-code{display:block}</style><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script><script src=/js/douban.js></script></div><div id=secondary><section class=widget><form id=search action=https://scottlx.github.io/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://scottlx.github.io>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=https://scottlx.github.io/posts/dpdk-rcu/ title="dpdk rcu lib" target=_blank>dpdk rcu lib</a></li><li><a href=https://scottlx.github.io/posts/contiv-memif/ title="contiv memif" target=_blank>contiv memif</a></li><li><a href=https://scottlx.github.io/posts/raft%E9%80%89%E4%B8%BE%E6%B5%81%E7%A8%8B/ title=raft选举流程 target=_blank>raft选举流程</a></li><li><a href=https://scottlx.github.io/posts/etcd-client-v3%E8%BF%9E%E6%8E%A5%E6%B5%81%E7%A8%8B/ title="etcd client v3 连接流程" target=_blank>etcd client v3 连接流程</a></li><li><a href=https://scottlx.github.io/posts/%E5%8D%95%E8%B0%83%E6%A0%88/ title=单调栈 target=_blank>单调栈</a></li><li><a href=https://scottlx.github.io/posts/%E6%8B%93%E6%89%91%E6%8E%92%E5%BA%8F/ title=拓扑排序(选课) target=_blank>拓扑排序(选课)</a></li><li><a href=https://scottlx.github.io/posts/%E4%BC%98%E5%8A%BF%E6%B4%97%E7%89%8C%E7%94%B0%E5%BF%8C%E8%B5%9B%E9%A9%AC/ title=优势洗牌(田忌赛马) target=_blank>优势洗牌(田忌赛马)</a></li><li><a href=https://scottlx.github.io/posts/K8S%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ title=k8s源码分析 target=_blank>k8s源码分析</a></li><li><a href=https://scottlx.github.io/posts/redisServer/ title="redis Server" target=_blank>redis Server</a></li><li><a href=https://scottlx.github.io/posts/redis%E5%A4%9A%E8%8A%82%E7%82%B9/ title="redis 多节点" target=_blank>redis 多节点</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/categories/>分类</a></h3><ul class=widget-list><li><a href=https://scottlx.github.io/categories/%E6%8A%80%E6%9C%AF%E4%BB%8B%E7%BB%8D/>技术介绍 (10)</a></li><li><a href=https://scottlx.github.io/categories/%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%97/>操作指南 (1)</a></li><li><a href=https://scottlx.github.io/categories/%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/>算法笔记 (4)</a></li><li><a href=https://scottlx.github.io/categories/%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/>问题分析 (1)</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/tags/>标签</a></h3><div class=tagcloud><a href=https://scottlx.github.io/tags/BFS/>BFS</a>
<a href=https://scottlx.github.io/tags/DAG/>DAG</a>
<a href=https://scottlx.github.io/tags/cache/>cache</a>
<a href=https://scottlx.github.io/tags/contiv/>contiv</a>
<a href=https://scottlx.github.io/tags/dpdk/>dpdk</a>
<a href=https://scottlx.github.io/tags/ebpf/>ebpf</a>
<a href=https://scottlx.github.io/tags/etcd/>etcd</a>
<a href=https://scottlx.github.io/tags/go/>go</a>
<a href=https://scottlx.github.io/tags/grpc/>grpc</a>
<a href=https://scottlx.github.io/tags/k8s/>k8s</a>
<a href=https://scottlx.github.io/tags/kubernetes/>kubernetes</a>
<a href=https://scottlx.github.io/tags/nfv/>nfv</a>
<a href=https://scottlx.github.io/tags/paas/>paas</a>
<a href=https://scottlx.github.io/tags/raft/>raft</a>
<a href=https://scottlx.github.io/tags/rcu/>rcu</a>
<a href=https://scottlx.github.io/tags/redis/>redis</a>
<a href=https://scottlx.github.io/tags/sdn/>sdn</a>
<a href=https://scottlx.github.io/tags/srv6/>srv6</a>
<a href=https://scottlx.github.io/tags/vpp/>vpp</a>
<a href=https://scottlx.github.io/tags/vpp-agent/>vpp-agent</a>
<a href=https://scottlx.github.io/tags/xdp/>xdp</a>
<a href=https://scottlx.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/>中间件</a>
<a href=https://scottlx.github.io/tags/%E4%BA%91%E5%B9%B3%E5%8F%B0/>云平台</a>
<a href=https://scottlx.github.io/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/>动态规划</a>
<a href=https://scottlx.github.io/tags/%E5%8D%95%E8%B0%83%E6%A0%88/>单调栈</a>
<a href=https://scottlx.github.io/tags/%E6%8B%93%E6%89%91%E6%8E%92%E5%BA%8F/>拓扑排序</a>
<a href=https://scottlx.github.io/tags/%E6%8E%92%E5%BA%8F/>排序</a>
<a href=https://scottlx.github.io/tags/%E6%95%B0%E4%BD%8Ddp/>数位dp</a>
<a href=https://scottlx.github.io/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/>源码分析</a>
<a href=https://scottlx.github.io/tags/%E7%8A%B6%E6%80%81%E5%8E%8B%E7%BC%A9/>状态压缩</a>
<a href=https://scottlx.github.io/tags/%E7%AE%97%E6%B3%95/>算法</a>
<a href=https://scottlx.github.io/tags/%E8%B4%AA%E5%BF%83/>贪心</a>
<a href=https://scottlx.github.io/tags/%E9%AB%98%E6%80%A7%E8%83%BD%E7%BD%91%E7%BB%9C/>高性能网络</a></div></section><section class=widget><h3 class=widget-title>友情链接</h3><ul class=widget-list><li><a target=_blank href=https://scottlx.github.io/ title=windseek的博客>windseek的博客</a></li></ul></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=https://scottlx.github.io/index.xml>文章 RSS</a></li></ul></section></div></div></div></div></body></html>