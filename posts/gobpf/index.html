<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>gobpf不完整使用指南</title><link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://scottlx.github.io/favicon.png rel=icon><meta name=description content><meta name=keywords content><meta name=author content="windseek"><meta name=generator content="Hugo 0.119.0"></head><body><header role=banner><hgroup><h1><a href=https://scottlx.github.io/>windseek</a></h1><h2>be curious, be free</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://scottlx.github.io/>» Blog</option><option value=https://scottlx.github.io/archives/>» Archives</option><option value=https://scottlx.github.io/cheatsheet/>» CheatSheet</option><option value=https://scottlx.github.io/about/>» Aboutme</option></select></fieldset><ul class=main-navigation><li><a href=https://scottlx.github.io/ title=Blog>Blog</a></li><li><a href=https://scottlx.github.io/archives/ title=Archives target=_blank rel="noopener noreferrer">Archives</a></li><li><a href=https://scottlx.github.io/cheatsheet/ title=CheatSheet target=_blank rel="noopener noreferrer">CheatSheet</a></li><li><a href=https://scottlx.github.io/about/ title=Aboutme target=_blank rel="noopener noreferrer">Aboutme</a></li></ul><ul class=subscription></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://scottlx.github.io/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Oct 3, 2022
- 2 minute read
- <a href=https://scottlx.github.io/posts/gobpf/#disqus_thread>Comments</a>
- <a class=label href=https://scottlx.github.io/categories/%e6%93%8d%e4%bd%9c%e6%8c%87%e5%8d%97/>操作指南</a></p><h1 class=entry-title>gobpf不完整使用指南</h1></header><div class=entry-content><nav id=TableOfContents><ul><li><ul><li><a href=#编译过程>编译过程</a></li><li><a href=#内核版本要求>内核版本要求</a></li><li><a href=#bpf_map>bpf_map</a></li><li><a href=#pinning-object>pinning object</a></li><li><a href=#packet-processing>packet processing</a></li><li><a href=#example>Example</a></li><li><a href=#参考文档>参考文档</a></li></ul></li></ul></nav><h3 id=编译过程>编译过程</h3><h4 id=安装llvm-10clang-10>安装llvm-10,clang-10</h4><p>apt-install llvm-10 clang-10</p><h4 id=下载bpf2go>下载bpf2go</h4><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>go install github.com/cilium/ebpf/cmd/bpf2go@latest
</span></span></code></pre></div><p>修改bpf程序的include</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&#34;common.h&#34;</span><span style=color:#719e07>
</span></span></span></code></pre></div><h4 id=编译时将bpd的headers包含进来>编译时将bpd的headers包含进来</h4><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#268bd2>GOPACKAGE</span><span style=color:#719e07>=</span>main bpf2go -cc clang-10 -cflags <span style=color:#2aa198>&#39;-O2 -g -Wall -Werror&#39;</span> -target bpfel,bpfeb bpf helloworld.bpf.c -- -I /root/ebpf/examples/headers
</span></span></code></pre></div><p>得到大端和小端两个版本的ELF文件，之后在go程序里加载即可。cpu一般都是小端。</p><h3 id=内核版本要求>内核版本要求</h3><p>经测试一些gobpf的一些syscall不适配较低版本的内核（例如5.8的BPF_LINK_CREATE会报参数错误），建议使用最新版本内核5.19</p><h3 id=bpf_map>bpf_map</h3><p>用户态程序首先加载bpf maps，再将bpf maps绑定到fd上。elf文件中的realocation table用来将代码中的bpf maps重定向至正确的fd上,用户程序在fd上发起bpf syscall</p><p>map的value尽量不要存复合数据结构，若bpf程序和用户态程序共用一个头文件，用户态程序调用bpf.Lookup时由于结构体变量unexported而反射失败</p><h3 id=pinning-object>pinning object</h3><p>将map挂载到/sys/fs/bpf</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>ebpf.CollectionOptions{
</span></span><span style=display:flex><span>   Maps: ebpf.MapOptions{
</span></span><span style=display:flex><span>      <span style=color:#586e75>// Pin the map to the BPF filesystem and configure the
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>      <span style=color:#586e75>// library to automatically re-write it in the BPF
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>      <span style=color:#586e75>// program so it can be re-used if it already exists or
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>      <span style=color:#586e75>// create it if not
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>      PinPath: pinPath
</span></span></code></pre></div><p>其他用户态程序获取pinned map的fd</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>ebpf.LoadPinnedMap
</span></span></code></pre></div><h3 id=packet-processing>packet processing</h3><p>使用系统/usr/include下的包头解析lib</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;stddef.h&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;linux/bpf.h&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;linux/in.h&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;linux/if_ether.h&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;linux/if_packet.h&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;linux/ipv6.h&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;linux/icmpv6.h&gt;</span><span style=color:#719e07>
</span></span></span></code></pre></div><p>其中ubuntu缺失asm库，需要安装gcc-multilib</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>apt-get install -y gcc-multilib
</span></span></code></pre></div><p>ctx存放dma区报文的指针，同时存放报文的设备号和队列号</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#719e07>struct</span> xdp_md {
</span></span><span style=display:flex><span>	__u32 data;
</span></span><span style=display:flex><span>	__u32 data_end;
</span></span><span style=display:flex><span>	__u32 data_meta;
</span></span><span style=display:flex><span>	<span style=color:#586e75>/* Below access go through struct xdp_rxq_info */</span>
</span></span><span style=display:flex><span>	__u32 ingress_ifindex; <span style=color:#586e75>/* rxq-&gt;dev-&gt;ifindex */</span>
</span></span><span style=display:flex><span>	__u32 rx_queue_index;  <span style=color:#586e75>/* rxq-&gt;queue_index  */</span>
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>由于ctx中的指针会发生变动，一般创建两个局部变量来存</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#dc322f>void</span> <span style=color:#719e07>*</span>data_end <span style=color:#719e07>=</span> (<span style=color:#dc322f>void</span> <span style=color:#719e07>*</span>)(<span style=color:#dc322f>long</span>)ctx<span style=color:#719e07>-&gt;</span>data_end;
</span></span><span style=display:flex><span><span style=color:#dc322f>void</span> <span style=color:#719e07>*</span>data <span style=color:#719e07>=</span> (<span style=color:#dc322f>void</span> <span style=color:#719e07>*</span>)(<span style=color:#dc322f>long</span>)ctx<span style=color:#719e07>-&gt;</span>data;
</span></span></code></pre></div><p>为了缩减报文边界检查次数（例如，先检查eth头长度是否合法，再检查ip头长度是否合法，会造成多次检查，影响性能），检查器在加载bpf程序时就会根据针对data_end的if语句进行静态检查。例如某bpf函数内需要读data指针后10个地址的数据，需要进行如下的校验，否则检查器会拒绝加载 XDP 子节代码</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#719e07>if</span> (data <span style=color:#719e07>+</span> <span style=color:#2aa198>10</span> <span style=color:#719e07>&lt;</span> data_end)
</span></span><span style=display:flex><span>  <span style=color:#586e75>/* do something with the first 10 bytes of data */</span>
</span></span><span style=display:flex><span><span style=color:#719e07>else</span>
</span></span><span style=display:flex><span>  <span style=color:#586e75>/* skip the packet access */</span>
</span></span></code></pre></div><h3 id=example>Example</h3><p>按照
<a href=https://github.com/xdp-project/xdp-tutorial target=_blank rel=noopener>xdp-project/xdp-tutorial: XDP tutorial (github.com)</a>移植的gobpf程序（还未完成）：</p><p><a href=https://github.com/scottlx/go-base/tree/main/src/ebpf/xdp-ex target=_blank rel=noopener>go-base/src/ebpf/xdp-ex at main · scottlx/go-base (github.com)</a></p><h3 id=参考文档>参考文档</h3><ol><li><p><a href=https://github.com/torvalds/linux/tree/master/samples/bpf target=_blank rel=noopener>linux/samples/bpf at master · torvalds/linux (github.com)</a></p></li><li><p><a href=http://arthurchiao.art/blog/bpf-advanced-notes-1-zh/ target=_blank rel=noopener>BPF 进阶笔记（一）：BPF 程序（BPF Prog）类型详解：使用场景、函数签名、执行位置及程序示例 (arthurchiao.art)</a></p></li><li><p><a href=https://liuhangbin.netlify.app/post/ebpf-and-xdp/ target=_blank rel=noopener>tc/BPF and XDP/BPF - Hangbin Liu&rsquo;s blog (liuhangbin.netlify.app)</a></p></li><li><p>[BPF and XDP Reference Guide — Cilium 1.12.2 documentation](
<a href="https://docs.cilium.io/en/stable/bpf/#:~:text=cBPF" target=_blank rel=noopener>https://docs.cilium.io/en/stable/bpf/#:~:text=cBPF</a> is known,before program execution.)</p></li></ol></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>windseek</span></span>
<time>Oct 3, 2022</time>
<span class=categories>Tags:
<a class=category href=https://scottlx.github.io/tags/ebpf>ebpf</a> <a class=category href=https://scottlx.github.io/tags/xdp>xdp</a> <a class=category href=https://scottlx.github.io/tags/%e9%ab%98%e6%80%a7%e8%83%bd%e7%bd%91%e7%bb%9c>高性能网络</a></span></p><p class=meta><a class="basic-alignment left" href=https://scottlx.github.io/posts/%E5%88%9D%E8%AF%86ebpf/ title=初识ebpf>初识ebpf</a>
<a class="basic-alignment right" href=https://scottlx.github.io/posts/redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/ title="redis 数据结构">redis 数据结构</a></p><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//scottlx.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><h1>Who am I</h1><p><p>云原生网络开发 &ndash;> 高级网管(笑</p><p>golang、云计算、SDN、NFV、软件架构</p><p>记录一些工作上的笔记，主要是以太网数据面开发（包括不限于dpdk，ebpf，ovs，dpvs，vpp&mldr;)以及k8s</p><p>也会记录一些web3方面的学习探索</p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="noopener noreferrer" href=https://github.com/scottlx title=https://github.com/scottlx><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href="https://www.facebook.com/profile.php?id=100009824623685" title="https://www.facebook.com/profile.php?id=100009824623685"><i class="fa fa-facebook fa-3x"></i></a></li></ul><section class=odd></section><section class=even><h1>Recent Posts</h1><ul id=recent_posts></ul></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2025 windseek - <a href=https://scottlx.github.io/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>