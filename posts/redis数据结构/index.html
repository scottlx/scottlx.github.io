<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>redis 数据结构</title><link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://scottlx.github.io/favicon.png rel=icon><meta name=description content><meta name=keywords content><meta name=author content="windseek"><meta name=generator content="Hugo 0.119.0"></head><body><header role=banner><hgroup><h1><a href=https://scottlx.github.io/>windseek</a></h1><h2>be curious, be free</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://scottlx.github.io/>» Blog</option><option value=https://scottlx.github.io/archives/>» Archives</option><option value=https://scottlx.github.io/cheatsheet/>» CheatSheet</option><option value=https://scottlx.github.io/about/>» Aboutme</option></select></fieldset><ul class=main-navigation><li><a href=https://scottlx.github.io/ title=Blog>Blog</a></li><li><a href=https://scottlx.github.io/archives/ title=Archives target=_blank rel="noopener noreferrer">Archives</a></li><li><a href=https://scottlx.github.io/cheatsheet/ title=CheatSheet target=_blank rel="noopener noreferrer">CheatSheet</a></li><li><a href=https://scottlx.github.io/about/ title=Aboutme target=_blank rel="noopener noreferrer">Aboutme</a></li></ul><ul class=subscription></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://scottlx.github.io/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Oct 3, 2022
- 1 minute read
- <a href=https://scottlx.github.io/posts/redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/#disqus_thread>Comments</a>
- <a class=label href=https://scottlx.github.io/categories/%e6%8a%80%e6%9c%af%e4%bb%8b%e7%bb%8d/>技术介绍</a></p><h1 class=entry-title>redis 数据结构</h1></header><div class=entry-content><nav id=TableOfContents><ul><li><ul><li><a href=#sds>SDS</a></li><li><a href=#链表>链表</a></li><li><a href=#字典>字典</a></li><li><a href=#跳表>跳表</a></li><li><a href=#整数集合>整数集合</a></li><li><a href=#压缩列表>压缩列表</a></li><li><a href=#对象>对象</a></li></ul></li></ul></nav><p>此系列作为redis设计与实现的笔记，会将本人自认为重点部分单独拎出来，并加入本人的一些理解。</p><h3 id=sds>SDS</h3><p>（simple dynamic string）</p><p>等同于go里的slice</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#719e07>struct</span> sdshdr {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#dc322f>int</span> len;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#dc322f>int</span> free;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#dc322f>char</span> buf[];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>优点：</p><ul><li>杜绝缓冲区溢出（free检验）</li><li>减少修改字符串时的内存分配次数（策略：小于1MB时，len=free，大于1MB时，free=1MB）</li><li>惰性空间释放（删除时实际空间并未缩减）</li><li>二进制安全（C字符串视/0为结束，不能用来存带/0的二进制数据）</li><li>部分兼容C字符串函数（默认在char数组最后加入/0，来兼容C字符串函数）</li></ul><h3 id=链表>链表</h3><p>双向链表，无环，保存头指针和尾指针，保存链表长度字段，链表节点的数据为void*指针</p><h3 id=字典>字典</h3><p>字典有type，每个type实现了一系列操作kv的函数（对比，生成哈希，删除，复制等）</p><p>每个字典存有两个哈希表，一般用第一个ht[0]，第二个ht[1]用作rehash时的暂存容器</p><p>哈希表由数组实现，数组存放kv链表头节点，链地址法解决冲突，冲突的新键值往表头加（由于没有指向表尾的指针）</p><p>rehash标志位，当没有进行rehash时为-1</p><p>key&ndash;>(hashfunc)&ndash;>hash&ndash;>(hashmask)&ndash;>index</p><p>murmurhash算法：输入有规律情况还是能生成随机分布性的hash</p><h4 id=rehash>rehash</h4><p>为ht[1]哈希表分配空间，空间的大小取决于当前ht[0]包含的键值数量以及要进行的操作，重新计算所有键值在ht[1]的索引并插入，插入后将ht[1]设置为ht[0]，并ht[1]指向新创的空白hash表</p><p>负载因子=ht[0].used/ht[0].size</p><h5 id=何时进行扩展>何时进行扩展?</h5><p>在进行持久化操作时(BGSAVE,BGREWRITEAOF)，负载因子>=5，普通场景下负载因子>=1</p><h5 id=何时进行收缩>何时进行收缩?</h5><p>负载因子&lt;0.1</p><h5 id=渐进式rehash>渐进式rehash</h5><p>开始时rehashidx为0，表示正在进行rehash，rehash期间对字典的CRUD会顺带将ht[0]上的KV rehash到ht[1]，完成后rehashidx置为-1,表示已经完成。rehash期间的CRUD会先在ht[0]上查，查不到再去ht[1]查</p><h3 id=跳表>跳表</h3><p>用来实现有序集合键，用作集群节点内部数据结构</p><p>优点，相较于平衡树，实现简单，且rebalance的效率高（局部rebalance，只修改搜索路径上的节点）</p><p>链表的扩展，维护了多个指向其他节点的指针，类似二分查找</p><p>每个节点的层数是随机生成的，遍历时先走最上层的前进指针，若下一条节点的分值比要查找的分值高，则通过回退指针回到原来的节点并走下一层的前进指针，以此类推</p><p>前进指针中存有跨度，累加所有跨度，当找到该节点后作为该节点在跳表中的排位（数组的index）</p><p>比较分值时，分值可能相同，相同时比较value值（obj指向的sds的字典序）</p><p>节点更新时，若score的改变未影响排序，则查找并直接改score，否则进行先删除后插入操作，会进行两次路径搜索</p><h3 id=整数集合>整数集合</h3><p>底层保存的整数为byte数组(int8)，按照解码类型(encoding)存入int16，int32或int64的数据</p><p>只能存一种类型的数据，短int集合中插入长int后，往长int类型兼容（升级）</p><p>节约内存，int16不需要分配int64的空间</p><p>自适应灵活性，集合中添加长度更长的新元素，会自动升级，但不支持降级</p><h3 id=压缩列表>压缩列表</h3><p>为了节约内存，将键值为小整数值和短字符串的entry按照特殊编排压缩为一段内存块</p><p>先略过</p><h3 id=对象>对象</h3><p>创建键值对时，键和值都被封装成对象，并指明对象的类型，编码以及底层数据结构的指针</p><p>key总是字符串对象，value可以是字符串对象，列表对象，哈希对象，集合对象，有序集合对象(zset)</p><p>编码指定了底层数据结构, 每种对象类型有多种编码的实现</p><h4 id=字符串对象>字符串对象</h4><p>long：value是数字，可以用long存</p><p>raw：value是字符串，长度大于32byte，用sds存，sds的内存是另外一块，和redisObject不连续</p><p>embstr：value是字符串，长度小于32byte，用sds存，sds的内存与redisObject的内存连续 （好处：减少分配和释放内存的次数，增加缓存命中率；坏处：没有实现写方法，只读，修改的话需要先转raw）</p><h4 id=列表对象>列表对象</h4><p>ziplist：redisObject的ptr指向压缩列表（条件：每个字符串长度&lt;64byte且列表长度&lt;512）</p><p>linkedlist：构造元素为字符串对象的双向链表（列表对象中嵌套了字符串对象）</p><h4 id=哈希对象>哈希对象</h4><p>ziplist: 按照旧键+旧值+新键+新值的顺序添加至压缩列表中</p><p>hashtable: 构造键值为字符串对象的字典（哈希对象中嵌套了字符串对象）</p><h4 id=集合对象>集合对象</h4><p>intset: 整数集合（条件：元素都是整数且个数不超过512）</p><p>hashtable: 构造键为字符串对象的字典，值为null（哈希对象中嵌套了字符串对象）</p><h4 id=有序集合对象>有序集合对象</h4><p>ziplist: 按分值从小到大排列</p><p>skiplist: 构造元素为字符串对象的跳表。同时构造key为字符串对象，值为分值的字典（字符串对象和值与跳表用的是同一内存），用来根据成员查分值</p><h4 id=命令的类型检查与多态>命令的类型检查与多态</h4><p>先判断type支不支持该命令，再通过encoding决定命令的实现方式</p><p>对象通过引用计数(ref)来决定是否被回收，相同字符串对象只对底层对象的引用计数增加而不新创建对象（只有字符串对象有共享机制，其他对象判断对象相同的复杂度太高）</p><p>0-9999所有整数在初始化时创建默认字符串对象</p><p>对象还有lru属性，用于lru算法老化内存</p></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>windseek</span></span>
<time>Oct 3, 2022</time>
<span class=categories>Tags:
<a class=category href=https://scottlx.github.io/tags/cache>cache</a> <a class=category href=https://scottlx.github.io/tags/redis>redis</a> <a class=category href=https://scottlx.github.io/tags/%e4%b8%ad%e9%97%b4%e4%bb%b6>中间件</a></span></p><p class=meta><a class="basic-alignment left" href=https://scottlx.github.io/posts/gobpf/ title=gobpf不完整使用指南>gobpf不完整使用指南</a>
<a class="basic-alignment right" href=https://scottlx.github.io/posts/redis%E5%A4%9A%E8%8A%82%E7%82%B9/ title="redis 多节点">redis 多节点</a></p><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//scottlx.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><h1>Who am I</h1><p><p>云原生网络开发 &ndash;> 高级网管(笑</p><p>golang、云计算、SDN、NFV、软件架构</p><p>记录一些工作上的笔记，主要是以太网数据面开发（包括不限于dpdk，ebpf，ovs，dpvs，vpp&mldr;)以及k8s</p><p>也会记录一些web3方面的学习探索</p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="noopener noreferrer" href=https://github.com/scottlx title=https://github.com/scottlx><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href="https://www.facebook.com/profile.php?id=100009824623685" title="https://www.facebook.com/profile.php?id=100009824623685"><i class="fa fa-facebook fa-3x"></i></a></li></ul><section class=odd></section><section class=even><h1>Recent Posts</h1><ul id=recent_posts></ul></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2025 windseek - <a href=https://scottlx.github.io/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>