<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>contiv memif</title>
<link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://scottlx.github.io/favicon.png rel=icon><meta name=description content><meta name=keywords content><meta name=author content="windseek"><meta name=generator content="Hugo 0.144.0"></head><body><header role=banner><hgroup><h1><a href=https://scottlx.github.io/>windseek的博客</a></h1><h2>golang、云计算、SDN、NFV、软件架构</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://scottlx.github.io/tools/>» 工具</option><option value=https://scottlx.github.io/archives/>» 归档</option></select></fieldset><ul class=main-navigation><li><a href=https://scottlx.github.io/tools/ title=工具 target=_blank rel="noopener noreferrer">工具</a></li><li><a href=https://scottlx.github.io/archives/ title=归档 target=_blank rel="noopener noreferrer">归档</a></li></ul><ul class=subscription></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://scottlx.github.io/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Apr 7, 2023
- 1 minute read
- <a href=https://scottlx.github.io/posts/contiv-memif/#disqus_thread>Comments</a>
- <a class=label href=https://scottlx.github.io/categories/%e6%8a%80%e6%9c%af%e4%bb%8b%e7%bb%8d/>技术介绍</a></p><h1 class=entry-title>contiv memif</h1></header><div class=entry-content><h3 id=contiv-memif>contiv memif</h3><p>contiv的cni与device plugin相结合，实现了：</p><ol><li>Pod能同时接入不止一张网卡</li><li>Pod接入的网卡可以是tap，veth，memif</li></ol><h4 id=deviceplugin>devicePlugin</h4><p>Device Plugin实际是一个运行在Kubelet所在的Node上的gRPC server，通过Unix Socket、基于以下（简化的）API来和Kubelet的gRPC server通信，并维护对应设备资源在当前Node上的注册、发现、分配、卸载。
其中，<code>ListAndWatch()</code>负责对应设备资源的discovery和watch；<code>Allocate()</code>负责设备资源的分配。</p><p><img src=/img/vpp-agent/6F9684EB-7E5E-4b77-9316-32D5C92FD07E.png alt=6F9684EB-7E5E-4b77-9316-32D5C92FD07E></p><h4 id=insight>Insight</h4><p><img src=/img/vpp-agent/contiveCNI.drawio.png alt=contiveCNI.drawio></p><h5 id=kubelet>kubelet</h5><p>kubelet接收上图格式的API。API中的annotations定义了pod的网卡个数与类型，resources中定义了所需要的device plugin的资源，也就是memif。</p><p>kubelet执行常规的syncPod流程，调用contiv cni创建网络。此时会在请求中将annotation传递给cni。</p><p>同时，agent的DevicePluginServer会向kubelet注册rpc服务，注册contivpp.io/memif的设备资源，从而kubelet的device manager会grpc请求DevicePluginServer获取contivpp.io/memif设备资源。</p><h5 id=cni>cni</h5><p>cni实现了github.com/containernetworking/cni标准的add和del接口。实际上做的事情只是将cni请求转换为了对agent的grpc请求：解析args，并通过grpc调用agent的接口发送cniRequest，再根据grpc的返回结果，将结果再次转换成标准cni接口的返回格式</p><h5 id=agent>Agent</h5><h6 id=podmanager>podmanager</h6><p>podmanager实现了上述cni调用的grpc server，主要任务是将cni的request转换为内部的event数据格式，供event loop处理。</p><p>request是cni定义的请求数据类型，详见https://github.com/containernetworking/cni/blob/master/SPEC.md#parameters</p><p>event则是agent内部的关于pod事务模型，类似原生kvScheduler的针对vpp api的transaction。每一种event都会对应一个plugin去实现他的handler，供event loop调用。</p><h6 id=event-loop>event loop</h6><p>event loop是整个contiv agent的核心处理逻辑，北向对接event queue，南向调用各个EventHandler，将event转换为kvScheduler的事务。</p><p>执行了以下步骤：</p><ol><li>对事件的预处理，包括校验，判断事件类型，加载必要的配置等</li><li>判断是否是更新的事件</li><li>对事件的handler进行排序，并生成正向或回退的handler顺序</li><li>与本次事件无关的handler过滤掉</li><li>创建对这次事件的记录record</li><li>打印上述步骤生成的所有事件相关信息</li><li>执行事件更新或同步，生成vpp-agent里的事务</li><li>将contiv生成的配置与外部配置进行merge，得到最终配置</li><li>将最终配置的vpp-agent事务commit到agent的kvscheduler</li><li>若事务失败，将已经完成的操作进行回退</li><li>完成事件，输出记录record与计时</li><li>打印回退失败等不可恢复的异常</li><li>若开启一致性检查，则最好再执行一次同步校验</li></ol><h6 id=devicemanager>devicemanager</h6><p>devicemanager既实现了对接kublet的DevicePluginServer，又实现了AllocateDevice类型的event的handler。换句话说是自己产生并处理自己的event。</p><p>主要业务逻辑：</p><ol><li><p>创建memif socket文件的目录并挂载至容器</p></li><li><p>创建连接socket的secret。</p></li></ol><p>上述的创建并不是真实的创建，而是把需要的信息(event.Envs, event.Annotations, event.Mounts)通过grpc返回给kublet，让kubelet去创建。</p><p>devicemanager还会将上述memif的信息保存在缓存中，供其他插件来获取。若缓存中信息不存在，则会调用kubelet的api获取信息。</p><h6 id=ipnet>ipNet</h6><p>ipNet插件主要负责node和pod中各类网卡的创建销毁，vxlan的分配，vrf的分配等</p><p>更新网卡时，ipnet会读取annotation中kv，判断网卡类型。若类型为memif，则会向deviceManager获取当前pod里各容器的memifInfo，之后根据memifInfo里的socket地址和secret，创建memif类型的网卡事务，并 push 至kvscheduler</p></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>windseek</span></span>
<time>Apr 7, 2023</time>
<span class=categories>Tags:
<a class=category href=https://scottlx.github.io/tags/vpp>vpp</a> <a class=category href=https://scottlx.github.io/tags/vpp-agent>vpp-agent</a> <a class=category href=https://scottlx.github.io/tags/k8s>k8s</a> <a class=category href=https://scottlx.github.io/tags/contiv>contiv</a></span></p><p class=meta><a class="basic-alignment left" href=https://scottlx.github.io/posts/%E6%95%B0%E4%BD%8Ddp/ title=数位dp>数位dp</a>
<a class="basic-alignment right" href=https://scottlx.github.io/posts/dpdk-rcu/ title="dpdk rcu lib">dpdk rcu lib</a></p><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//scottlx.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><h1>Sidebar Header</h1><p><p>Here&rsquo;s a
<a href=https://www.google.com target=_blank rel=noopener>link to google</a></p><p>New paragraph</p><p>Another paragraph which has two spaces in the end to create a new line using markdown<br>New line but not a new paragraph</p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="noopener noreferrer" href=https://github.com/scottlx title=https://github.com/scottlx><i class="fa fa-github fa-3x"></i></a></li></ul><section class=odd><h1>Sidebar Links</h1><li><a href=https://scottlx.github.io/about title="About me">About me</a></li></section><section class=even><h1>Recent Posts</h1><ul id=recent_posts></ul></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2025 windseek - <a href=https://scottlx.github.io/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>